<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Form Filler from JSON | PDF Analyzer Pro</title>
    <meta name="description" content="A powerful, 100% client-side tool to fill PDF forms using JSON data. Analyze any fillable PDF to generate a strict JSON template, then paste your data to create a completed, downloadable PDF. Secure, private, and perfect for automation.">
    <meta name="keywords" content="pdf filler, json to pdf, fill pdf from json, pdf automation, pdf form filler, fillable pdf, client-side pdf tool, pdf-lib, bros ai">
    <link rel="canonical" href="https://bros-ai.github.io/PDF-Analyzer-Pro/">
    
    <!-- PDF.js for PDF parsing & analysis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- pdf-lib for PDF creation & modification -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
        --primary-color: #1a73e8; --primary-dark: #1255a5; --secondary-color: #5f6368;
        --accent-success: #1e8e3e; --accent-error: #d93025; --accent-warning: #f9ab00;
        --background-color: #f8f9fa; --surface-color: #ffffff; --on-surface-color: #202124;
        --border-color: #dadce0; --font-family: 'Roboto', sans-serif; --border-radius: 12px;
        --shadow-1: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        --shadow-2: 0 4px 8px 0 rgba(60,64,67,0.15), 0 6px 20px 0 rgba(60,64,67,0.1);
        --transition-speed: 0.2s ease-in-out;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--on-surface-color); line-height: 1.6; }
        .app-container { max-width: 1200px; margin: 0 auto; padding: 24px; display: flex; flex-direction: column; min-height: 100vh; }
        /* --- Header & Typography --- */
        .header { text-align: center; margin-bottom: 32px; }
        .header h1 { font-size: 2.8em; font-weight: 700; margin-bottom: 8px; }
        .header p { font-size: 1.2em; color: var(--secondary-color); max-width: 800px; margin: 0 auto; }
        .section-title { font-size: 1.5em; font-weight: 500; color: var(--on-surface-color); margin-bottom: 16px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .main-content { flex-grow: 1; }
        /* --- Card & Layout --- */
        .card {
        background-color: var(--surface-color); border: 1px solid var(--border-color);
        border-radius: var(--border-radius); padding: 32px; margin-bottom: 32px;
        box-shadow: var(--shadow-1); transition: box-shadow var(--transition-speed);
        }
        .card:hover { box-shadow: var(--shadow-2); }
        /* --- Upload Section --- */
        .upload-container {
        text-align: center; border: 2px dashed var(--border-color);
        border-radius: var(--border-radius); padding: 48px 24px;
        transition: border-color var(--transition-speed), background-color var(--transition-speed);
        }
        .upload-container.drag-over { border-color: var(--primary-color); background-color: #e8f0fe; }
        .upload-icon { color: var(--primary-color); }
        .upload-icon svg { width: 48px; height: 48px; fill: currentColor; }
        .upload-container h2 { font-size: 1.5em; margin-top: 16px; }
        .upload-container p { color: var(--secondary-color); margin: 8px 0 16px; }
        #file-input { display: none; }
        /* --- Controls & Buttons --- */
        .action-buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 16px; margin-top: 24px; }
        .btn {
        display: inline-flex; align-items: center; justify-content: center; font-weight: 500;
        font-size: 1em; padding: 10px 24px; border-radius: 8px; border: 1px solid transparent;
        cursor: pointer; transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); box-shadow: var(--shadow-1); }
        .btn-secondary { background-color: transparent; color: var(--secondary-color); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: #f1f3f4; }
        .btn-success { background-color: var(--accent-success); color: white; }
        .btn-success:hover { background-color: #1a7f37; box-shadow: var(--shadow-1); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        /* --- PDF Queue --- */
        .pdf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }
        .pdf-grid.item-count-1 { grid-template-columns: 1fr; max-width: 500px; margin: 0 auto; }
        .pdf-grid.item-count-2 { grid-template-columns: 1fr 1fr; max-width: 1100px; margin: 0 auto; }

        .pdf-card {
        background: var(--surface-color); border-radius: var(--border-radius); overflow: hidden;
        box-shadow: var(--shadow-1); display: flex; flex-direction: column;
        transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        border-left: 4px solid var(--accent-success);
        }
        .pdf-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-2); }
        .pdf-thumbnail { width: 100%; height: 160px; background-color: var(--background-color); display: flex; align-items: center; justify-content: center; }
        .pdf-thumbnail img { width: 100%; height: 100%; object-fit: contain; }
        .pdf-info { padding: 16px; flex-grow: 1; display: flex; flex-direction: column; }
        .pdf-filename { font-weight: 500; font-size: 0.9em; word-break: break-all; margin-bottom: 4px; }
        .pdf-stats { font-size: 0.8em; color: var(--secondary-color); margin-bottom: 12px; }
        .pdf-actions { display: flex; gap: 8px; margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-color);}
        .pdf-actions .btn { flex: 1; padding: 6px 8px; font-size: 0.8em; }
        /* --- PDF Filling Section --- */
        .pdf-filler-section { margin-top: 16px; margin-bottom: 16px; }
        .pdf-filler-section h4 { font-size: 0.9em; font-weight: 500; margin-bottom: 8px; text-align: center; }
        .pdf-filler-section textarea { width: 100%; min-height: 120px; font-family: monospace; font-size: 0.85em; resize: vertical; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--background-color); margin-top: 8px;}
        .pdf-filler-section textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px #d2e3fc; }
        .pdf-filler-section .btn { width: 100%; margin-top: 8px; }
        .filler-status { font-size: 0.8em; text-align: center; margin-top: 4px; height: 1.2em; font-weight: 500; }
        .filler-status.success { color: var(--accent-success); }
        .filler-status.error { color: var(--accent-error); }
        /* --- Footer --- */
        .app-footer { border-top: 1px solid var(--border-color); padding: 40px 0 20px; margin-top: 64px; color: var(--secondary-color); }
        .footer-content { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px; }
        .made-with-love { color: var(--secondary-color); text-decoration: none; font-weight: 500; transition: color var(--transition-speed); }
        .made-with-love:hover { color: var(--primary-color); }
        .heart { color: #e74c3c; display: inline-block; animation: heartbeat 1.5s ease-in-out infinite; }
        .footer-links { display: flex; gap: 16px; }
        .footer-links a { color: var(--secondary-color); transition: color var(--transition-speed); }
        .footer-links a:hover { color: var(--primary-color); }
        /* --- Loading & Error --- */
        .error-message { color: var(--accent-error); font-weight: 500; text-align: center; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; padding: 20px; }
        .loading-overlay.visible { display: flex; }
        .spinner { width: 48px; height: 48px; border: 5px solid #d2e3fc; border-bottom-color: var(--primary-color); border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        .loading-content { max-width: 600px; }
        .author-chat-panel { background: white; border-radius: 12px; padding: 20px; box-shadow: var(--shadow-2); margin: 20px 0; display: flex; gap: 16px; align-items: flex-start; text-align: left; }
        .author-avatar { width: 60px; height: 60px; border-radius: 50%; flex-shrink: 0; }
        .chat-bubble p { margin-bottom: 12px; font-size: 0.95em; line-height: 1.5; }
        .chat-bubble p:last-child { margin-bottom: 0; }
        .main-progress-text { font-size: 1.1em; margin-top: 20px; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>PDF Analyzer & Filler Pro</h1>
            <p>Generate a JSON map from a PDF's form fields, fill it with your data, and download the completed document instantly. 100% private and secure.</p>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Upload Section -->
            <section class="upload-section card">
                <div class="upload-container" id="upload-container">
                    <div class="upload-icon" aria-hidden="true">
                        <svg height="48px" viewBox="0 0 24 24" width="48px" aria-label="Document upload icon"><path d="M0 0h24v24H0z" fill="none"/><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
                    </div>
                    <h2>Drag & drop a fillable PDF here</h2>
                    <p>or</p>
                    <label for="file-input" class="btn btn-primary">Browse File</label>
                    <input type="file" id="file-input" accept=".pdf,application/pdf" multiple aria-label="Select PDF files">
                    <div id="error-message" class="error-message" role="alert" style="margin-top:20px;"></div>
                </div>
            </section>

            <!-- PDF Queue Section -->
            <section class="pdf-queue-section" id="pdf-queue-section" style="display: none;">
                <h2 class="section-title">Your PDF Files (<span id="pdf-count">0</span>)</h2>
                <div class="pdf-grid" id="pdf-grid"></div>
                <div class="action-buttons">
                    <button id="reset-btn" class="btn btn-secondary">Reset and Start Over</button>
                </div>
            </section>
        </main>
        
        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                <a href="https://bros.ai" target="_blank" rel="noopener noreferrer" class="made-with-love">
                    Made with <span class="heart" aria-label="love">❤️</span> by Bros AI
                </a>
                <div class="footer-links">
                    <a href="https://github.com/Bros-AI/PDF-Analyzer-Pro" target="_blank" rel="noopener noreferrer" aria-label="Project on GitHub"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a>
                    <a href="https://x.com/GauthierBros" target="_blank" rel="noopener noreferrer" aria-label="Gauthier Bros on X (formerly Twitter)"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
                    <a href="https://www.linkedin.com/in/gauthier-bros/" target="_blank" rel="noopener noreferrer" aria-label="Gauthier Bros on LinkedIn"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="author-chat-panel">
                <img src="https://github.com/BrosG.png" alt="Photo of Gauthier Bros" class="author-avatar">
                <div class="chat-bubble">
                    <p>Hi! Gauthier here.</p>
                    <p>My algorithms are working their magic on your PDF. This process is 100% private and happens entirely in your browser. Your file is never uploaded anywhere.</p>
                </div>
            </div>
            <p class="main-progress-text" id="loading-text">Preparing analysis...</p>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        class PDFFiller {
            constructor() {
                this.state = { files: [] };
                this.elements = this.initializeElements();
                this.initializeEventListeners();
                this.loadingStartTime = null;
                this.MIN_LOADING_TIME = 1500;
            }

            initializeElements() {
                return {
                    uploadContainer: document.getElementById('upload-container'),
                    fileInput: document.getElementById('file-input'),
                    resetBtn: document.getElementById('reset-btn'),
                    pdfQueueSection: document.getElementById('pdf-queue-section'),
                    pdfGrid: document.getElementById('pdf-grid'),
                    pdfCount: document.getElementById('pdf-count'),
                    errorMessage: document.getElementById('error-message'),
                    loadingOverlay: document.getElementById('loading-overlay'),
                    loadingText: document.getElementById('loading-text'),
                };
            }

            initializeEventListeners() {
                this.elements.fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files));
                this.setupDragAndDrop();
                this.elements.resetBtn.addEventListener('click', () => this.resetApplication());
                this.elements.pdfGrid.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const card = target.closest('.pdf-card');
                    const fileId = card.dataset.id;
                    if (target.classList.contains('remove-btn')) this.removePDF(fileId);
                    if (target.classList.contains('get-json-btn')) this.handleGetFillableJSON(fileId);
                    if (target.classList.contains('fill-pdf-btn')) this.handleFillAndDownload(fileId);
                });
            }

            async handleGetFillableJSON(fileId) {
                const fileObj = this.state.files.find(f => f.id === fileId);
                const card = this.elements.pdfGrid.querySelector(`[data-id="${fileId}"]`);
                const textarea = card.querySelector('.filler-textarea');
                const statusEl = card.querySelector('.filler-status');

                if (!fileObj || !fileObj.analysis) {
                    this.showStatus(statusEl, "Analysis data not found.", 'error');
                    return;
                }

                if (fileObj.analysis.fieldDetails.length === 0) {
                     this.showStatus(statusEl, "No fillable form fields found in this PDF.", 'error');
                     textarea.value = "[]";
                     return;
                }
                
                const jsonTemplate = fileObj.analysis.fieldDetails.map(field => ({
                    fieldName: field.fieldName,
                    type: field.fieldType,
                    options: field.options.length > 0 ? field.options.map(opt => opt.displayValue || opt) : null,
                    value: field.fieldValue || ""
                }));

                textarea.value = JSON.stringify(jsonTemplate, null, 2);
                this.showStatus(statusEl, "JSON template generated successfully!", 'success');
            }

            async handleFillAndDownload(fileId) {
                this.showLoading(true, 'Filling your PDF...');
                const fileObj = this.state.files.find(f => f.id === fileId);
                const card = this.elements.pdfGrid.querySelector(`[data-id="${fileId}"]`);
                const textarea = card.querySelector('.filler-textarea');
                const statusEl = card.querySelector('.filler-status');
                
                // **FIX 1: Robust Input Validation**
                const jsonText = textarea.value.trim();
                if (!jsonText) {
                    this.showStatus(statusEl, "Error: JSON data area is empty.", 'error');
                    this.showLoading(false);
                    return;
                }
                
                let data;
                try {
                    data = JSON.parse(jsonText);
                } catch (e) {
                    this.showStatus(statusEl, "Error: Invalid JSON format.", 'error');
                    this.showLoading(false);
                    return;
                }

                if (!Array.isArray(data)) {
                    this.showStatus(statusEl, "Error: JSON data must be an array.", 'error');
                    this.showLoading(false);
                    return;
                }
                
                try {
                    const { PDFDocument } = PDFLib;
                    // Use the safe, non-detached ArrayBuffer
                    const pdfDoc = await PDFDocument.load(fileObj.arrayBuffer);
                    const form = pdfDoc.getForm();

                    data.forEach(field => {
                        try {
                            const formField = form.getField(field.fieldName);
                            if (!formField) {
                                console.warn(`Field "${field.fieldName}" not found in PDF form.`);
                                return;
                            }
                            
                            if (formField instanceof PDFLib.PDFTextField) {
                                formField.setText(String(field.value || ''));
                            } else if (formField instanceof PDFLib.PDFCheckBox) {
                                if (field.value === true) formField.check();
                                else formField.uncheck();
                            } else if (formField instanceof PDFLib.PDFDropdown) {
                                if (field.value) formField.select(String(field.value));
                            } else if (formField instanceof PDFLib.PDFRadioGroup) {
                                if (field.value) formField.select(String(field.value));
                            }
                        } catch(e) {
                             console.error(`Could not fill field '${field.fieldName}': ${e.message}`);
                        }
                    });
                    
                    const pdfBytes = await pdfDoc.save();
                    const filledBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const newFileName = fileObj.file.name.replace('.pdf', '-filled.pdf');
                    this.triggerDownload(URL.createObjectURL(filledBlob), newFileName);
                    this.showStatus(statusEl, "PDF filled and download started!", 'success');

                } catch (error) {
                    console.error("PDF filling failed:", error);
                    this.showStatus(statusEl, `Error: ${error.message}`, 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            setupDragAndDrop() {
                const dropZone = this.elements.uploadContainer;
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false));
                ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false));
                ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false));
                dropZone.addEventListener('drop', (e) => this.handleFileSelect(e.dataTransfer.files), false);
            }

            async handleFileSelect(files) {
                if (!files || files.length === 0) return;
                this.showLoading(true, `Analyzing ${files.length} PDF(s)...`);
                const filePromises = Array.from(files).map(file => this.processFile(file)).filter(p => p);
                await Promise.all(filePromises);
                this.renderPDFGrid();
                this.updateUIState();
                this.showLoading(false);
            }

            processFile(file) {
                if (!file.type.match(/^application\/pdf$/i)) {
                    this.showError(`${file.name} is not a valid PDF file.`);
                    return null;
                }
                return new Promise(resolve => {
                    const fileReader = new FileReader();
                    fileReader.onload = async (e) => {
                        try {
                            const originalBuffer = e.target.result;
                            
                            // **FIX 2: Create a safe copy for pdf-lib before pdf.js detaches the original**
                            const bufferForPdfLib = originalBuffer.slice(0);
                            const bufferForPdfJs = new Uint8Array(originalBuffer);

                            const pdf = await pdfjsLib.getDocument({ data: bufferForPdfJs }).promise;
                            const thumbnailUrl = await this.generatePDFThumbnail(pdf);
                            
                            const fileObj = {
                                id: `${file.name}-${file.size}-${Date.now()}`,
                                file,
                                arrayBuffer: bufferForPdfLib, // Store the safe copy
                                pdfDocument: pdf,
                                original: { 
                                    pages: pdf.numPages,
                                    thumbnailUrl, 
                                    size: file.size 
                                },
                                status: 'pending',
                                analysis: null,
                            };
                            
                            fileObj.analysis = await this.performPDFAnalysis(pdf);
                            fileObj.status = 'done';
                            this.state.files.push(fileObj);
                            resolve();

                        } catch (error) {
                            console.error(error);
                            this.showError(`Could not analyze PDF: ${file.name}. Is it a valid, uncorrupted file?`);
                            resolve();
                        }
                    };
                    fileReader.onerror = () => { 
                        this.showError(`Could not read ${file.name}`); 
                        resolve(); 
                    };
                    fileReader.readAsArrayBuffer(file);
                });
            }
            
            async performPDFAnalysis(pdfDocument) {
                const analysis = { fieldDetails: [] };
                for (let pageNum = 1; pageNum <= pdfDocument.numPages; pageNum++) {
                    const page = await pdfDocument.getPage(pageNum);
                    const annotations = await page.getAnnotations();
                    annotations
                        .filter(ann => ann.subtype === 'Widget' && ann.fieldName)
                        .forEach(field => {
                            if (!analysis.fieldDetails.some(f => f.fieldName === field.fieldName)) {
                                analysis.fieldDetails.push({
                                    fieldName: field.fieldName,
                                    fieldType: field.fieldType,
                                    fieldValue: field.fieldValue || '',
                                    options: field.options || []
                                });
                            }
                        });
                }
                return analysis;
            }

            async generatePDFThumbnail(pdf) {
                try {
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 0.5 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    await page.render({ canvasContext: ctx, viewport }).promise;
                    return canvas.toDataURL('image/jpeg');
                } catch (error) {
                    console.error('Error generating thumbnail:', error);
                    return null;
                }
            }

            updateUIState() {
                const hasFiles = this.state.files.length > 0;
                this.elements.pdfQueueSection.style.display = hasFiles ? 'block' : 'none';
                this.elements.pdfCount.textContent = this.state.files.length;
            }

            renderPDFGrid() {
                const grid = this.elements.pdfGrid;
                grid.innerHTML = '';
                
                grid.classList.remove('item-count-1', 'item-count-2');
                const count = this.state.files.length;
                if (count === 1) grid.classList.add('item-count-1');
                if (count === 2) grid.classList.add('item-count-2');
                
                this.state.files.forEach(fileObj => {
                    const card = document.createElement('div');
                    card.className = `pdf-card`;
                    card.dataset.id = fileObj.id;
                    const fieldCount = fileObj.analysis ? fileObj.analysis.fieldDetails.length : 0;
                    
                    card.innerHTML = `
                        <div class="pdf-thumbnail">
                            <img src="${fileObj.original.thumbnailUrl}" alt="Preview of ${fileObj.file.name}">
                        </div>
                        <div class="pdf-info">
                            <p class="pdf-filename">${fileObj.file.name}</p>
                            <p class="pdf-stats">${fileObj.original.pages} pages | ${fieldCount} fillable form fields</p>
                            
                            <div class="pdf-filler-section">
                                <button class="btn btn-secondary get-json-btn">1. Get Fillable Fields JSON</button>
                                <textarea class="filler-textarea" placeholder="Click button above to generate a template, or paste your completed JSON here..."></textarea>
                                <div class="filler-status"></div>
                                <button class="btn btn-success fill-pdf-btn">2. Fill PDF & Download</button>
                            </div>

                            <div class="pdf-actions">
                                <button class="btn btn-secondary remove-btn">Remove</button>
                            </div>
                        </div>`;
                    grid.appendChild(card);
                });
            }

            triggerDownload(href, filename) {
                const link = document.createElement('a');
                link.href = href; link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(href), 1000);
            }

            removePDF(fileId) {
                this.state.files = this.state.files.filter(f => f.id !== fileId);
                this.renderPDFGrid();
                this.updateUIState();
            }

            resetApplication() {
                if (this.state.files.length > 0 && !confirm('Are you sure? This will clear all PDF files.')) return;
                this.state = { files: [] };
                this.elements.fileInput.value = '';
                this.renderPDFGrid();
                this.updateUIState();
            }
            
            showError(message) { 
                const el = this.elements.errorMessage;
                el.textContent = message;
                el.style.display = 'block';
                setTimeout(() => { el.style.display = 'none'; el.textContent = ''; }, 5000); 
            }

            showStatus(element, message, type = 'info') {
                element.textContent = message;
                element.className = `filler-status ${type}`;
                setTimeout(() => element.textContent = '', 5000);
            }
            
            showLoading(show, text = 'Processing...') {
                if (show) {
                    this.elements.loadingText.textContent = text; 
                    this.elements.loadingOverlay.classList.add('visible');
                    this.loadingStartTime = Date.now();
                } else {
                    if (!this.loadingStartTime) {
                        this.elements.loadingOverlay.classList.remove('visible');
                        return;
                    }
                    const elapsedTime = Date.now() - this.loadingStartTime;
                    const remainingTime = this.MIN_LOADING_TIME - elapsedTime;
                    
                    if (remainingTime > 0) {
                        setTimeout(() => {
                            this.elements.loadingOverlay.classList.remove('visible');
                            this.loadingStartTime = null;
                        }, remainingTime);
                    } else {
                        this.elements.loadingOverlay.classList.remove('visible');
                        this.loadingStartTime = null;
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.pdfFiller = new PDFFiller();
        });
    </script>
</body>
</html>